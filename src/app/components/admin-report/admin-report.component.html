<div class="report-container">
  <div class="report-header">
    <h1 class="report-title">Admin Investment Reports</h1>
    <div class="header-buttons">
      <button class="refresh-btn" (click)="recalculateAllInterest()" [disabled]="loading || isRecalculating" title="Recalculate Interest for All Investors" style="background: linear-gradient(135deg, #e91e63, #c2185b);">
        <span class="material-icons">refresh</span>
        {{ isRecalculating ? 'Recalculating...' : 'Recalculate Interest' }}
      </button>
      <button class="refresh-btn" (click)="applyAdminMonthlyInterest()" [disabled]="loading || isRecalculating" title="Apply Monthly Interest Using Admin Rates" style="background: linear-gradient(135deg, #4caf50, #2e7d32);">
        <span class="material-icons">trending_up</span>
        Apply Monthly Interest
      </button>
      <button class="refresh-btn" (click)="runAdminCalculationVerification()" [disabled]="loading || isRecalculating" title="Verify Admin Report Calculations" style="background: linear-gradient(135deg, #ff9800, #f57c00);">
        <span class="material-icons">verified</span>
        {{ isRecalculating ? 'Verifying...' : 'Advanced Testing' }}
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="loading-message">
    <div class="loading-spinner">
      <div class="spinner"></div>
    </div>
    <h3>Loading Investment Data...</h3>
    <p>Please wait while we fetch your investment reports.</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="error-message">
    <div class="error-icon">
      <span class="material-icons">error</span>
    </div>
    <h3>Error Loading Data</h3>
    <p>{{ error }}</p>
    <button class="retry-btn" (click)="ngOnInit()">
      <span class="material-icons">refresh</span>
      Try Again
    </button>
  </div>

  <!-- No Data State -->
  <div *ngIf="!loading && !error && reports.length === 0" class="no-data-message">
    <div class="no-data-icon">
      <span class="material-icons">assessment</span>
    </div>
    <h3>No Investment Data Available</h3>
    <p>No investment data is currently available to generate reports. This could be due to:</p>
    <ul>
      <li>No investors have been added yet</li>
      <li>No transactions have been recorded</li>
      <li>Connection issues with the database</li>
    </ul>
  </div>

  <!-- Verification Results -->
  <div *ngIf="showVerificationResults && verificationResults" class="verification-results">
    <div class="verification-header">
      <h2>üß™ Admin Calculation Verification Results</h2>
      <button class="close-btn" (click)="closeVerificationResults()" title="Close Results">
        <span class="material-icons">close</span>
      </button>
    </div>
    
    <div class="verification-summary">
      <div class="summary-item">
        <span class="summary-label">Total Investors:</span>
        <span class="summary-value">{{ verificationResults.totalInvestors }}</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Passed:</span>
        <span class="summary-value passed">{{ verificationResults.passed }}</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Failed:</span>
        <span class="summary-value failed">{{ verificationResults.failed }}</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">Success Rate:</span>
        <span class="summary-value">{{ getSuccessRate() }}%</span>
      </div>
    </div>

    <div class="verification-details">
      <h3>Detailed Results</h3>
      <div class="verification-list">
        <div 
          *ngFor="let result of verificationResults.details" 
          class="verification-item"
          [ngClass]="getStatusClass(result.status)">
          
          <div class="verification-item-header">
            <span class="verification-icon">{{ getStatusIcon(result.status) }}</span>
            <span class="verification-name">{{ result.investorName }}</span>
          </div>
          
          <div class="verification-message">
            {{ result.message }}
          </div>

          <div class="verification-details-expanded" *ngIf="result.details">
            <div class="details-section">
              <h4>Expected Results:</h4>
              <div class="detail-grid">
                <div class="detail-item">
                  <span class="detail-label">Final Balance:</span>
                  <span class="detail-value">{{ formatCurrency(result.details.expected.finalBalance) }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Total Invested:</span>
                  <span class="detail-value">{{ formatCurrency(result.details.expected.totalInvested) }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Total Withdrawn:</span>
                  <span class="detail-value">{{ formatCurrency(result.details.expected.totalWithdrawn) }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Total Interest:</span>
                  <span class="detail-value">{{ formatCurrency(result.details.expected.totalInterest) }}</span>
                </div>
              </div>
            </div>

            <div class="details-section">
              <h4>Actual Results:</h4>
              <div class="detail-grid">
                <div class="detail-item">
                  <span class="detail-label">Final Balance:</span>
                  <span class="detail-value">{{ formatCurrency(result.details.actual.finalBalance) }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Total Invested:</span>
                  <span class="detail-value">{{ formatCurrency(result.details.actual.totalInvested) }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Total Withdrawn:</span>
                  <span class="detail-value">{{ formatCurrency(result.details.actual.totalWithdrawn) }}</span>
                </div>
                <div class="detail-item">
                  <span class="detail-label">Total Interest:</span>
                  <span class="detail-value">{{ formatCurrency(result.details.actual.totalInterest) }}</span>
                </div>
              </div>
            </div>

            <div class="details-section">
              <h4>Verification:</h4>
              <div class="verification-grid">
                <div class="verification-check">
                  <span class="check-label">Balance Match:</span>
                  <span class="check-value" [ngClass]="result.details.balanceMatch ? 'match-pass' : 'match-fail'">
                    {{ result.details.balanceMatch ? '‚úÖ' : '‚ùå' }}
                  </span>
                </div>
                <div class="verification-check">
                  <span class="check-label">Invested Match:</span>
                  <span class="check-value" [ngClass]="result.details.investedMatch ? 'match-pass' : 'match-fail'">
                    {{ result.details.investedMatch ? '‚úÖ' : '‚ùå' }}
                  </span>
                </div>
                <div class="verification-check">
                  <span class="check-label">Withdrawn Match:</span>
                  <span class="check-value" [ngClass]="result.details.withdrawnMatch ? 'match-pass' : 'match-fail'">
                    {{ result.details.withdrawnMatch ? '‚úÖ' : '‚ùå' }}
                  </span>
                </div>
                <div class="verification-check">
                  <span class="check-label">Interest Match:</span>
                  <span class="check-value" [ngClass]="result.details.interestMatch ? 'match-pass' : 'match-fail'">
                    {{ result.details.interestMatch ? '‚úÖ' : '‚ùå' }}
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div *ngFor="let report of reports" class="report-card">
    <div class="report-card-header">
      <h2 class="investor-name">{{ report.investorName }}</h2>
    </div>

    <div class="stats-grid">
      <div class="stat-card principal">
        <div class="stat-icon">
          <span class="material-icons">account_balance</span>
        </div>
        <div class="stat-content">
          <h3>Principal Amount</h3>
          <p class="stat-value">{{ report.principal | currency:'INR':'symbol':'1.2-2' }}</p>
        </div>
      </div>
      <div class="stat-card interest">
        <div class="stat-icon">
          <span class="material-icons">trending_up</span>
        </div>
        <div class="stat-content">
          <h3>Total Interest</h3>
          <p class="stat-value">{{ report.totalInterest | currency:'INR':'symbol':'1.2-2' }}</p>
          <div *ngIf="report.monthlyInterestBreakdown.length > 0" class="average-return">
            <small class="average-return-text">
              Average Return: {{ (report.averageReturnPercentage * 100).toFixed(2) }}%
            </small>
          </div>
        </div>
      </div>
      <div class="stat-card capital">
        <div class="stat-icon">
          <span class="material-icons">savings</span>
        </div>
        <div class="stat-content">
          <h3>Grown Capital</h3>
          <p class="stat-value">{{ report.grownCapital | currency:'INR':'symbol':'1.2-2' }}</p>
        </div>
      </div>
    </div>

    <div *ngIf="report.transactions.length > 0" class="transactions-section">
      <h3 class="section-title">Transaction History</h3>
      <div class="table-container">
        <table class="transactions-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Description</th>
              <th>Principal</th>
              <th>Interest</th>
              <th>Withdrawal</th>
              <th>Balance</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let t of report.transactions">
              <td>{{ formatDate(t.date) }}</td>
              <td class="transaction-type">{{ t.type }}</td>
              <td class="amount principal-amount">
                <span *ngIf="t.type === 'invest' || t.type === 'deposit'">
                  {{ t.amount | currency:'INR':'symbol':'1.2-2' }}
                </span>
              </td>
              <td class="amount interest-amount">
                <span *ngIf="t.type === 'interest'">
                  {{ t.amount | currency:'INR':'symbol':'1.2-2' }}
                  <small class="interest-rate">({{ getTransactionInterestRate(t.date) }})</small>
                </span>
              </td>
              <td class="amount withdrawal-amount">
                <span *ngIf="t.type === 'withdraw'">
                  {{ t.amount | currency:'INR':'symbol':'1.2-2' }}
                </span>
              </td>
              <td class="amount balance-amount">{{ t.balance | currency:'INR':'symbol':'1.2-2' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <div *ngIf="report.transactions.length === 0" class="no-transactions">
      <span class="material-icons">receipt_long</span>
      <p>No transactions found for this period.</p>
    </div>
  </div>
</div>
